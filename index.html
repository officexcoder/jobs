<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Secure Job Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- NEW: SheetJS for Excel -->
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<style>
body { margin:0; background:#0f1117; color:#e6e6eb; font-family:system-ui,sans-serif; }
h1,h2 { text-align:center; }
input,select,textarea,button {
  width:100%; padding:10px; margin:6px 0;
  background:#1c1f2a; color:#fff;
  border:1px solid #333; border-radius:6px;
}
button { background:#3b6df6; border:none; font-weight:600; }
button.secondary { background:#555; }
.container { max-width:1000px; margin:auto; padding:16px; }
.grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:10px; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th,td { border:1px solid #333; padding:6px; font-size:14px; }
.warning { background:#3b2f00; }
.expired { background:#3b0000; }

#lock {
  position:fixed; inset:0; background:#000;
  display:flex; align-items:center; justify-content:center;
}
#lockBox { width:320px; padding:20px; }
#error { color:#ff6b6b; font-size:14px; min-height:18px; }
.actions { display:flex; gap:10px; flex-wrap:wrap; }
</style>
</head>

<body>

<div id="lock">
  <div id="lockBox">
    <h2>üîê Secure Job Tracker</h2>
    <input type="password" id="password" placeholder="Master password">
    <button id="unlockBtn">Unlock / Create Vault</button>
    <div id="error"></div>
    <small>Password is never stored. Lose it = data lost.</small>
  </div>
</div>

<div class="container" id="app" hidden>
<h1>Job Applications</h1>

<div class="grid">
<input id="company" placeholder="Company">
<input id="title" placeholder="Job Title">
<input id="source" placeholder="Source">
<input id="resume" placeholder="Resume Version">
<input type="date" id="applied">
<input type="number" id="follow" value="7" placeholder="Follow-up days">
<select id="status">
<option>Applied</option>
<option>Interview</option>
<option>Rejected</option>
<option>Offer</option>
</select>
</div>

<textarea id="notes" placeholder="Notes / contacts / login hints"></textarea>

<div class="actions">
<button id="addBtn">Add Application</button>

<!-- existing -->
<button class="secondary" onclick="exportEncrypted()">Encrypted Export</button>

<!-- NEW -->
<button class="secondary" onclick="importEncrypted()">Encrypted Import</button>
<button class="secondary" onclick="exportExcel()">Excel Export</button>
<button class="secondary" onclick="importExcel()">Excel Import</button>

<button class="secondary" onclick="clearOld()">Clear Old (90+ days)</button>
<button class="secondary" onclick="location.reload()">Lock</button>
</div>

<table>
<thead>
<tr>
<th>Company</th><th>Title</th><th>Status</th>
<th>Applied</th><th>Follow-up</th><th>Notes</th>
</tr>
</thead>
<tbody id="list"></tbody>
</table>
</div>

<input type="file" id="fileInput" hidden>

<script>
const enc = new TextEncoder();
const dec = new TextDecoder();
let cryptoKey = null;
let jobs = [];

/* ===== Crypto ===== */
async function deriveKey(password) {
  const baseKey = await crypto.subtle.importKey(
    "raw", enc.encode(password), "PBKDF2", false, ["deriveKey"]
  );
  return crypto.subtle.deriveKey(
    { name:"PBKDF2", salt:enc.encode("job-tracker-salt"), iterations:150000, hash:"SHA-256" },
    baseKey,
    { name:"AES-GCM", length:256 },
    false,
    ["encrypt","decrypt"]
  );
}

async function encryptPayload(payload) {
  const iv = crypto.getRandomValues(new Uint8Array(12));
  const encrypted = await crypto.subtle.encrypt(
    { name:"AES-GCM", iv },
    cryptoKey,
    enc.encode(JSON.stringify(payload))
  );
  return JSON.stringify({
    iv: Array.from(iv),
    data: Array.from(new Uint8Array(encrypted))
  });
}

async function decryptPayload(payload) {
  const obj = JSON.parse(payload);
  const decrypted = await crypto.subtle.decrypt(
    { name:"AES-GCM", iv:new Uint8Array(obj.iv) },
    cryptoKey,
    new Uint8Array(obj.data)
  );
  return JSON.parse(dec.decode(decrypted));
}

/* ===== Unlock ===== */
async function unlock() {
  const pw = password.value;
  error.textContent = "";
  if (!pw) return error.textContent = "Enter a password.";

  try {
    cryptoKey = await deriveKey(pw);
    const stored = localStorage.getItem("jobVault");
    jobs = stored ? await decryptPayload(stored) : [];
    if (!stored) await save();
    lock.style.display = "none";
    app.hidden = false;
    render();
  } catch {
    error.textContent = "Wrong password or unsupported browser.";
  }
}

async function save() {
  localStorage.setItem("jobVault", await encryptPayload(jobs));
}

/* ===== Render ===== */
function render() {
  list.innerHTML = "";
  const now = new Date();
  jobs.forEach(j => {
    const tr = document.createElement("tr");
    const fd = new Date(j.follow);
    if (fd < now) tr.className = "expired";
    else if ((fd - now) / 86400000 < 3) tr.className = "warning";
    tr.innerHTML = `
      <td>${j.company}</td>
      <td>${j.title}</td>
      <td>${j.status}</td>
      <td>${j.applied}</td>
      <td>${j.follow}</td>
      <td>${j.notes}</td>`;
    list.appendChild(tr);
  });
}

/* ===== Add Job ===== */
async function addJob() {
  if (!applied.value) return alert("Select Date Applied");
  const a = new Date(applied.value);
  const f = new Date(a);
  f.setDate(f.getDate() + Number(follow.value || 7));
  jobs.push({
    company:company.value,
    title:title.value,
    status:status.value,
    applied:applied.value,
    follow:f.toISOString().slice(0,10),
    notes:notes.value
  });
  await save();
  render();
}

/* ===== Encrypted Export ===== */
async function exportEncrypted() {
  const encrypted = await encryptPayload({ exported:new Date().toISOString(), jobs });
  download(encrypted, `job-archive-${Date.now()}.enc.json`);
}

/* ===== NEW: Encrypted Import ===== */
async function importEncrypted() {
  pickFile(async file => {
    const payload = await file.text();
    const data = await decryptPayload(payload);
    jobs = data.jobs || [];
    await save();
    render();
  });
}

/* ===== NEW: Excel Export ===== */
function exportExcel() {
  const ws = XLSX.utils.json_to_sheet(jobs);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Jobs");
  XLSX.writeFile(wb, "job-tracker.xlsx");
}

/* ===== NEW: Excel Import ===== */
function importExcel() {
  pickFile(file => {
    const reader = new FileReader();
    reader.onload = e => {
      const wb = XLSX.read(e.target.result, { type:"binary" });
      jobs = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
      save().then(render);
    };
    reader.readAsBinaryString(file);
  });
}

/* ===== Clear Old (Encrypted Archive enforced) ===== */
async function clearOld(days=90) {
  const cutoff = new Date();
  cutoff.setDate(cutoff.getDate() - days);
  const old = jobs.filter(j => new Date(j.applied) < cutoff);
  if (!old.length) return alert("No old applications.");
  if (!confirm(`Encrypted backup will be saved before deletion.\nProceed?`)) return;
  await exportEncrypted();
  jobs = jobs.filter(j => new Date(j.applied) >= cutoff);
  await save();
  render();
}

/* ===== Utils ===== */
function pickFile(cb) {
  fileInput.onchange = () => cb(fileInput.files[0]);
  fileInput.click();
}
function download(data, name) {
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([data]));
  a.download = name;
  a.click();
}

unlockBtn.onclick = unlock;
addBtn.onclick = addJob;
</script>

</body>
</html>
